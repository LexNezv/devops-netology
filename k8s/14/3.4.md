# Домашнее задание к занятию «Обновление приложений»

### Цель задания

Выбрать и настроить стратегию обновления приложения.

### Чеклист готовности к домашнему заданию

1. Кластер K8s.

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Документация Updating a Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment).
2. [Статья про стратегии обновлений](https://habr.com/ru/companies/flant/articles/471620/).

-----

### Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор

1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
2. Ресурсы, выделенные для приложения, ограничены, и нет возможности их увеличить.
3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
5. Вам нужно объяснить свой выбор стратегии обновления приложения.

> Сразу не подходит Rolling update, т.к. новые и старые версии не смогут работать одновременно + ограниченный запас ресурсов для того, чтобы держать 2 версии одновременно. Можно использовать Recreate, но он приводит к downtime. Если нас устроит этот вариант, то можно использовать его. Если нет - тогда использовать bluegreen, в наименее загруженное время. Запустим новую версию но с меньшим числом реплик, оттетим и переходим на нее полностью, если все ок. Переходим = подностью отключаем старые реплики, добавляем новые. 

### Задание 2. Обновить приложение

1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5.
>[deployment](./deployment.yaml)
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.
```
kubectl -n app14 set image deployment/nginx-multitool nginx=nginx:1.20
kubectl -n app14 rollout status deployment/nginx-multitool
kubectl -n app14 get pods -l app=nginx-multitool -w

deployment.apps/nginx-multitool image updated
Waiting for deployment "nginx-multitool" rollout to finish: 1 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 1 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 1 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 2 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 2 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 2 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 3 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 3 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 3 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 4 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 4 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 4 out of 5 new replicas have been updated...
Waiting for deployment "nginx-multitool" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "nginx-multitool" rollout to finish: 1 old replicas are pending termination...
deployment "nginx-multitool" successfully rolled out
NAME                               READY   STATUS        RESTARTS   AGE
nginx-multitool-56f8d5c5b7-4xx72   2/2     Terminating   0          37s
nginx-multitool-56f8d5c5b7-h2ntj   2/2     Terminating   0          44s
nginx-multitool-56f8d5c5b7-k897s   2/2     Terminating   0          35s
nginx-multitool-56f8d5c5b7-kbgnz   2/2     Terminating   0          40s
nginx-multitool-56f8d5c5b7-rqwfh   2/2     Terminating   0          42s
nginx-multitool-66bcbd8b7-2lgr4    2/2     Running       0          5s
nginx-multitool-66bcbd8b7-86dsf    2/2     Running       0          17s
nginx-multitool-66bcbd8b7-d56v8    2/2     Running       0          6s
nginx-multitool-66bcbd8b7-mfx4d    2/2     Running       0          9s
nginx-multitool-66bcbd8b7-xc6rr    2/2     Running       0          2s
```
3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.
```
kubectl -n app14 set image deployment/nginx-multitool nginx=nginx:1.28
kubectl -n app14 rollout status deployment/nginx-multitool
kubectl -n app14 get pods -l app=nginx-multitool -w
```
4. Откатиться после неудачного обновления.
```
kubectl -n app14 rollout undo deployment/nginx-multitool
kubectl -n app14 get pods -l app=nginx-multitool
kubectl -n app14 describe deployment nginx-multitool | grep Image

    Image:        nginx:1.20
    Image:      wbitt/network-multitool
```

## Дополнительные задания — со звёздочкой*

Задания дополнительные, необязательные к выполнению, они не повлияют на получение зачёта по домашнему заданию. **Но мы настоятельно рекомендуем вам выполнять все задания со звёздочкой.** Это поможет лучше разобраться в материале.   

### Задание 3*. Создать Canary deployment

1. Создать два deployment'а приложения nginx.
> [deployment1](./deploymentv.yml)
```
kubectl -n app14 apply -f deployment1.yml,deployment2.yml
```
2. При помощи разных ConfigMap сделать две версии приложения — веб-страницы.
> [config](./config.yaml)
```
kubectl -n app14 apply -f config.yml
```
3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.
> [ingress](./ingress.yml)
```
kubectl -n app14 apply -f service.yml,ingress.yml
```
> Проверяем настройки ингресса
```
kubectl -n ingress-nginx get pod -o wide
kubectl describe ing nginx-canary -n app14       
Name:             nginx-canary
Labels:           <none>
Namespace:        app14
Address:          10.129.100.36
Ingress Class:    <none>
Default backend:  <default>
Rules:
  Host              Path  Backends
  ----              ----  --------
  testcanary.local  
                    /   nginx-v1:80 (10.244.191.82:80,10.244.29.144:80,10.244.197.207:80)
                    /   nginx-v2:80 (10.244.197.208:80)
Annotations:        kubernetes.io/ingress.class: nginx
                    nginx.ingress.kubernetes.io/canary: true
                    nginx.ingress.kubernetes.io/canary-weight: 30
Events:
  Type    Reason  Age                   From                      Message
  ----    ------  ----                  ----                      -------
  Normal  Sync    4m6s (x2 over 4m35s)  nginx-ingress-controller  Scheduled for sync
```
> Видим, что часть запросов попадает на v2
```
for i in 1 2 3 4 5 6 7 8 9 10; do curl 10.129.100.36 2>&1 | grep -e "NGINX v1" -e "NGINX v2"; done
```
