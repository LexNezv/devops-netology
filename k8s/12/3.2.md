# Домашнее задание к занятию «Установка Kubernetes»

### Цель задания

Установить кластер K8s.

### Чеклист готовности к домашнему заданию

1. Развёрнутые ВМ с ОС Ubuntu 20.04-lts.


### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Инструкция по установке kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/).
2. [Документация kubespray](https://kubespray.io/).

-----

### Задание 1. Установить кластер k8s с 1 master node

1. Подготовка работы кластера из 5 нод: 1 мастер и 4 рабочие ноды.
2. В качестве CRI — containerd.
3. Запуск etcd производить на мастере.
4. Способ установки выбрать самостоятельно.

## Ответ

- В качестве ос будет использован Ubuntu24 server, т.к. ubuntu 20 уже неактуален
- Начнем с настройки шаблонной ноды со всеми необходимыми утилитами, чтобы можно было сделать необходимое кол-во нод. Сначала устанавливаем containerd.
```
sudo apt install -y containerd
```
- Далее по [инструкции](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/) все необходимые утилиты. В качестве источника мы будем использовать nexus-proxy чтобы не скачивать каждый раз пакеты из интернета в дальнейшем.
```
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl gpg
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://nexus.local/repository/k8s-proxy /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```
Так же проводим доп настройки.
```
modprobe br_netfilter  
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf  
echo "net.bridge.bridge-nf-call-iptables=1" >> /etc/sysctl.conf  
echo "net.bridge.bridge-nf-call-arptables=1" >> /etc/sysctl.conf  
echo "net.bridge.bridge-nf-call-ip6tables=1" >> /etc/sysctl.conf  
sysctl -p /etc/sysctl.conf 
```
Подготовка шаблона завершена. Инициализируем.
```
kubeadm init --control-plane-endpoint=testk8s.local --pod-network-cidr 10.244.0.0/16
```
Итого мастер нода готова
```
kubectl get node
NAME                                STATUS   ROLES           AGE    VERSION
copy-of-vm-ak-cloudinit-u24-k8s-1   Ready    control-plane   4h7m   v1.33.1
```
Далее все просто, берем преднастроенные копии нод и присоединяем их командой, которую выводит kubeadm
```
kubeadm join 192.168.0.20:6443 --token pk2vau.yj3zvmft67bns0he --discovery-token-ca-cert-hash sha256:d82c58bdef32f79d0b25d9df43506d651df2a29506ffdbee770a96146e83efab
```
Итог
```
kubectl get nodes
NAME                                STATUS   ROLES           AGE     VERSION
k8s-master1                         Ready    control-plane   18h     v1.33.1
k8s-slave1                          Ready    <none>          5m17s   v1.33.1
k8s-slave2                          Ready    <none>          103s    v1.33.1
k8s-slave3                          Ready    <none>          101s    v1.33.1
k8s-slave4                          Ready    <none>          99s     v1.33.1
```

## Дополнительные задания (со звёздочкой)

------
### Задание 2*. Установить HA кластер

1. Установить кластер в режиме HA.
2. Использовать нечётное количество Master-node.
3. Для cluster ip использовать keepalived или другой способ.

## Ответ

- Импользую шаблон из предыдущего пункта.
- Устанавливаю и настраиваю доп инструменты на каждой мастер ноде для повышения отказовустойчивости
```
apt install -y keepalived haproxy
```
- ДОбавялю настройки по отказоустойчивости и 
- Инициализирую первую ноду
```
kubeadm init --pod-network-cidr=10.244.0.0/16 --control-plane-endpoint=192.168.0.30:8080 --upload-certs --apiserver-advertise-address=192.168.0.26 --apiserver-bind-port=6443
```
- Присоединяю остальные
```
kubeadm join 192.168.0.30:8080 --token q5cyy0.wd09ypyxek2uwogn    --discovery-token-ca-cert-hash sha256:3a5ff336827b0c35ddfde751f1b06a155fc238fd2c6ccde2c1fa4cda321ec7ea  --control-plane --certificate-key 6f22bd1e6d87cc113c26da249e579924fa34169b0eca52e8453415bf884ed385
```
- Итог
```
kubectl get nodes
NAME           STATUS   ROLES           AGE     VERSION
k8s-master11   Ready    control-plane   4m26s   v1.33.1
k8s-master22   Ready    control-plane   2m34s   v1.33.1
k8s-master33   Ready    control-plane   2m13s   v1.33.1
```
- выключаю одну ноду
```
kubectl get nodes
NAME           STATUS     ROLES           AGE     VERSION
k8s-master11   Ready      control-plane   5m51s   v1.33.1
k8s-master22   NotReady   control-plane   3m59s   v1.33.1
k8s-master33   Ready      control-plane   3m38s   v1.33.1
```




### Правила приёма работы

1. Домашняя работа оформляется в своем Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода необходимых команд `kubectl get nodes`, а также скриншоты результатов.
3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.
